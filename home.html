<!DOCTYPE html>
<html lang="en">
<head>
  <title>TurtleQue Desktop</title>
  <link rel="stylesheet" href="style.css" />

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
  <div class="desktop">
    <!-- Blog App Icon -->
    <div class="icon blog-icon">
      <a href="#" id="openBlogWindow">
        <img src="icon-blogs.png" alt="Blog Icon" />
      </a>
    </div>

    <!-- Profile App Icon -->
    <div class="icon profile-icon">
      <a href="#" id="openProfileWindow">
        <img src="icon-profile.png" alt="Profile Icon" />
      </a>
    </div>

    <!-- Blog Window -->
    <div id="blogWindow" class="window" style="display:none;">
      <div class="window-header">
        <span>Blog</span>
        <button id="closeBlogWindow">X</button>
      </div>
      <div class="window-content" id="blogContent">
        <div id="blogPosts"></div>
        <form id="blogForm">
          <input type="text" id="blogTitle" placeholder="Title" required style="width: 100%; margin-bottom: 5px;" />
          <textarea id="blogContentInput" placeholder="Write your post here..." required style="width: 100%; height: 80px;"></textarea>
          <button type="submit">Post Blog</button>
        </form>
      </div>
    </div>

    <!-- Profile Window -->
    <div id="profileWindow" class="window" style="display:none;">
      <div class="window-header">
        <span>Profile</span>
        <button id="closeProfileWindow">X</button>
      </div>
      <div class="window-content">
        <div style="display: flex; align-items: center; gap: 10px;">
          <img id="profilePic" src="default-pfp.png" width="64" height="64" style="border-radius: 50%; border: 2px solid #000080;" />
          <div>
            <div id="username-container" style="display: flex; align-items: center; gap: 5px;">
  <h3 id="username" style="margin: 0;">@username</h3>
  <button id="editUsernameBtn" title="Edit Username" style="background: none; border: none; cursor: pointer;">✏️</button>
</div>
<div id="usernameEdit" style="display: none; margin-top: 5px;">
  <input type="text" id="usernameInput" placeholder="New username" />
  <button id="saveUsernameBtn">✅</button>
</div>

            <p id="name">Full Name</p>
          </div>
        </div>
        <p>Followers: <span id="followers">0</span></p>
        <p>Following: <span id="following">0</span></p>
      </div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDbPW4QJXwz4zirD1eNni05Jv9jjvznBoc",
      authDomain: "turtleque-d4096.firebaseapp.com",
      projectId: "turtleque-d4096",
      storageBucket: "turtleque-d4096.firebasestorage.app",
      messagingSenderId: "1063279534551",
      appId: "1:1063279534551:web:12ca5515dae9e447c02b92"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Elements
    const blogWindow = document.getElementById('blogWindow');
    const openBlogBtn = document.getElementById('openBlogWindow');
    const closeBlogBtn = document.getElementById('closeBlogWindow');

    const profileWindow = document.getElementById('profileWindow');
    const openProfileBtn = document.getElementById('openProfileWindow');
    const closeProfileBtn = document.getElementById('closeProfileWindow');

    const blogPostsDiv = document.getElementById('blogPosts');
    const blogForm = document.getElementById('blogForm');
    const blogTitleInput = document.getElementById('blogTitle');
    const blogContentInput = document.getElementById('blogContentInput');

    // Blog logic
    openBlogBtn.addEventListener('click', e => {
      e.preventDefault();
      blogWindow.style.display = 'flex';
      loadPosts();
    });

    closeBlogBtn.addEventListener('click', () => {
      blogWindow.style.display = 'none';
    });

    function loadPosts() {
      blogPostsDiv.innerHTML = '<p>Loading blog posts...</p>';
      db.collection('posts')
        .orderBy('createdAt', 'desc')
        .get()
        .then(snapshot => {
          blogPostsDiv.innerHTML = '';
          snapshot.forEach(doc => {
            const post = doc.data();
            const postElem = document.createElement('div');
            postElem.style.borderBottom = '1px solid #ccc';
            postElem.style.marginBottom = '10px';
            postElem.innerHTML = `
              <h3>${post.title}</h3>
              <p>${post.content}</p>
              <small>${post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : 'Just now'}</small>
            `;
            blogPostsDiv.appendChild(postElem);
          });
          if (blogPostsDiv.innerHTML === '') {
            blogPostsDiv.innerHTML = '<p>No posts yet.</p>';
          }
        })
        .catch(error => {
          blogPostsDiv.innerHTML = `<p>Error loading posts: ${error.message}</p>`;
        });
    }

    blogForm.addEventListener('submit', e => {
      e.preventDefault();
      const title = blogTitleInput.value.trim();
      const content = blogContentInput.value.trim();
      if (!title || !content) return;

      db.collection('posts')
        .add({
          title,
          content,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        })
        .then(() => {
          blogTitleInput.value = '';
          blogContentInput.value = '';
          loadPosts();
        })
        .catch(err => {
          alert('Error adding post: ' + err.message);
        });
    });

    // Profile logic
    openProfileBtn.addEventListener("click", (e) => {
      e.preventDefault();
      profileWindow.style.display = "flex";
      loadUserProfile();
    });

    closeProfileBtn.addEventListener("click", () => {
      profileWindow.style.display = "none";
    });

    function loadUserProfile() {
      const user = auth.currentUser;
      if (!user) return;

      document.getElementById("username").textContent = user.email;

      db.collection("users").doc(user.uid).get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          document.getElementById("name").textContent = data.name || "Unknown";
          document.getElementById("followers").textContent = data.followers || 0;
          document.getElementById("following").textContent = data.following || 0;
          document.getElementById("profilePic").src = data.profilePicUrl || "default-pfp.png";
        }
      });
    }

    // Make both windows draggable
    function makeWindowDraggable(windowElement) {
      const header = windowElement.querySelector(".window-header");
      let isDragging = false, offsetX = 0, offsetY = 0;

      header.addEventListener("mousedown", (e) => {
        isDragging = true;
        offsetX = e.clientX - windowElement.offsetLeft;
        offsetY = e.clientY - windowElement.offsetTop;
        document.body.style.userSelect = "none";
      });

      window.addEventListener("mouseup", () => {
        isDragging = false;
        document.body.style.userSelect = "auto";
      });

      window.addEventListener("mousemove", (e) => {
        if (isDragging) {
          windowElement.style.left = (e.clientX - offsetX) + "px";
          windowElement.style.top = (e.clientY - offsetY) + "px";
        }
      });
    }

    makeWindowDraggable(blogWindow);
    makeWindowDraggable(profileWindow);
  </script>
</body>
</html>
